<!doctype html><html lang="en"><head><meta http-equiv="Content-type" content="text/html;charset=UTF-8"><meta name="Viewport" content="width=device-width,initial-scale=1,maximum-scale=1.0"><title>Adventures with Newsqueak, part 2 | r-wos.org</title> <style>
    * { line-height: 140%; }
    @-moz-keyframes blink {
 0% {
   opacity: 1;
 }
 50% {
   opacity: 0;
 }
 100% {
   opacity: 1;
 }
}

@-webkit-keyframes blink {
 0% {
   opacity: 1;
 }
 50% {
   opacity: 0;
 }
 100% {
   opacity: 1;
 }
}

@-o-keyframes blink {
 0% {
   opacity: 1;
 }
 50% {
   opacity: 0;
 }
 100% {
   opacity: 1;
 }
}

@keyframes blink {
 0% {
    opacity: 1;
 }
 50% {
    opacity: 0;
 }
 100% {
    opacity: 1;
 }
}

blink {
  display: inline;
  -webkit-animation: blink 1s steps(1) infinite;
  -moz-animation: blink 1s steps(1) infinite;
  -o-animation: blink 1s steps(1) infinite;
  animation: blink 1s steps(1) infinite;
}

    </style></head><body style="margin:15px auto;max-width:40em"> <nav> <a href="/">Home</a> - <a href="/blog">Blog</a> - <a href="/feed.xml">RSS</a> - <a href="/hacks">Hacks</a> - <a href="/about">About</a> </nav> <main><h1>Adventures with Newsqueak, part 2</h1><p>2011-11-09<p><a href="http://blog.r-wos.org/2011/adventures-with-newsqueak"><small>(part 1 is here)</small></a></p><p>I just ported a small testing script included in the source tree from rc (which is Plan9’s command interpreter) to bourne shell. And then I ran it, obviously.</p><p>The first test to fail was a small snippet called “fio”:</p><div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>include "fio.h"
F:=fopen("include/fio.h", 0);
a:array of char;
do{
    a=&lt;-F.in;
    print(a);
}while(len a);
</code></pre></div></div><p>This is pretty straight-forward. It includes the fio.h header (probably “file input output”) and then opens this exact header file and echoes it to standard output. The most notable thing about it is probably this line:</p><div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>a=&lt;-F.in;
</code></pre></div></div><p>which translates to English as “read from the channel F.in into a”. Channels are a thing unique to Newsqueak, but in this case this channel is basically only used like some kind of a character stream, very much like C++’s <code class="highlighter-rouge">std::iostream</code>. Channels can do more than that, some of which I covered in <a href="http://blog.r-wos.org/2011/channels-in-newsqueak">another blog post</a>.</p><p>But back to the test - why did it fail? Well, to be exact, the line that failed was the first one - the include. Here’s the <code class="highlighter-rouge">strace</code>.</p><div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>open("progs/fio", O_RDONLY)             = 3
read(3, "include \"fio.h\"\nF:=fopen(\"include"..., 8192) = 104
open("fio.h", O_RDONLY)                 = -1 ENOENT (No such file or directory)
open("/usr/rob/src/squint/include/fio.h", O_RDONLY) = -1 ENOENT (No such file or directory)
write(2, "progs/fio:1: can't open fio.h\n\n"..., 31progs/fio:1: can't open fio.h
</code></pre></div></div><p>As you can see, the include statement searches for “fio.h” in <code class="highlighter-rouge">/usr/rob/src/squint/include/</code>. That won’t bring up too much; I’m not Rob and modern Unix systems have their “user” directory under <code class="highlighter-rouge">/home</code> anyway.</p><p>(Note however, that this path does probably <em>not</em> stem from some ancient Unix machine (or a not-so-ancient FreeBSD machine), but from Plan9’s use of <code class="highlighter-rouge">/usr</code> for, well, <em>users</em>. Okay, back to the text:)</p><p>This path is actually hard-coded in the lexer, here’s the code from <code class="highlighter-rouge">lex.c</code>:</p><div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>349        char buf[1024];
350        fd=open(s, 0);
351        if(fd&lt;0 &amp;&amp; s[0]!='/' &amp;&amp; s[0]!='.'){
352            sprint(buf, "/usr/rob/src/squint/include/%s", s);
353            fd=open(buf, 0);
354        }
355        if(fd&lt;0)
356            error("can't open %s\n", s);
</code></pre></div></div><p>And this fact is even documented in a file called “sq” in the source tree:</p><div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>include "file"
include may appear anywhere an identifier is legal
if file is not found locally, and does not begin with a / or . ,
it is looked for in /usr/rob/squint/include.
</code></pre></div></div><p>So, what do we learn from all this?</p><ol><li><p>The Newsqueak “include” statement is handled by the lexer (which makes sense given that it’s much like the one in C, where the pre-processor handles it).</p></li><li><p>Obviously, this code was never used by anyone but Rob Pike himself (except for, maybe, people on the same machine - and other people called “Rob” running either old Unixes or Plan9).</p></li><li><p>Digging through other people’s code can be fun. Especially when the code is old and/or strange and has stories to tell.</p></li><li><p>This must be fixed.</p></li></ol><p>I’m not yet completely sure how to handle include file lookup. I will probably end up using some “config.h” with a compile-time constant, or just some hard-coded sane default. However, I think I’ll look at how python does this, first. There’s no rush, right?</p><p>In other news: <a href="http://github.com/rwos/Newsqueak">the interpreter</a> still doesn’t build with certain newer versions of <code class="highlighter-rouge">make</code> and/or <code class="highlighter-rouge">gcc</code> [nope, it was a 64 bit issue, see update below]. It’s probably not a code problem, so a fix will require someone to look through the Makefiles and stuff.</p><p>I will do that, but not right now, that’s just too boring and cumbersome after a long day at work.</p><p>(<strong>Update</strong>: Now it does build, and it <em>was</em> in fact a code problem: some of the included Plan9 libraries don’t build on 64 bit hosts. These are probably ancient versions of those libraries anyway, I’ll see if I can replace them with more current unix ports (or if those have the same problems))</p><p>As always: Happy Hacking!</p><hr><h2>See Also</h2><p>Previously: <a href="/blog/adventures-with-newsqueak">Adventures with Newsqueak</a></p><p>Next up: <a href="/blog/channels-in-newsqueak">Channels in Newsqueak</a></p><p> The machine thinks that the Web-Log entries <a href="/blog/ludum-dare-26-postmortem">26th Ludum Dare - Postmortem</a>, <a href="/blog/gherkin">Given When Then</a>, and <a href="/blog/test-driven">Test Driven Development</a> might be related to the topic so eloquently discussed above. The machine is sometimes right.</p></main></body></html>